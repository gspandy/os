<#assign shiro=JspTaglibs[ "http://shiro.apache.org/tags"] />
<script type="text/javascript">
	$(function() {
		<@shiro.user>
		var nickname = '<@shiro.principal property="nickname" />';
		if(nickname == 'null'){
			nickname = "(您未设置昵称)";
		}
		$("#nickName").text(nickname);
		</@shiro.user>
		removeSection = function(e) {
			$(e).parents(".section").remove();
			$('[data-spy="scroll"]').each(function() {
				var $spy = $(this).scrollspy('refresh')
			});
		}
		$("#myScrollspy").scrollspy();

		$("#sings").popover({
			html : true
		});
		$("#sings").attr("data-content", $("#signin").html());
		$(".popover-content").keypress(function(e) {
			if (e.ctrlKey && e.which == 13 || e.which == 10 || e.which == 13) {
				layer.alert("1")
				e.preventDefault();// 屏蔽enter对系统作用。按后增加\r\n等换行
			}
		});
		
		//点击空白，隐藏登录框
		$("#sings").on("click",function(){
			if(!$(this).attr('data-show')){
				$(this).attr('data-show','on');
				setTimeout(function(){
					$(document).on('click',showIcon);
				},100);
			}else{
				$(this).removeAttr('data-show');
				$(document).off('click',showIcon);
			}	
			//回车登录
			document.onkeydown=function(event){
				 var e = event || window.event || arguments.callee.caller.arguments[0];
				 if(e && e.keyCode==13){
					 login();
				 }
			}
		});
		$('body').on('click','.popover',function(ev){
			ev.stopPropagation();
		});
		var editObj = $("#sings");
		function showIcon(){
			editObj.click();
		}					
	});

	function to_singup() { //跳至注册
		//$("#sings").attr("data-content", $("#signup").html());
		$(".popover-content").html($("#signup").html());
	}
	function to_singin() { //跳至登录
		//$("#sings").attr("data-content", $("#signup").html());
		$(".popover-content").html($("#signin").html());
	}

	function regist() {
		var account = $(".popover-content #account"), password = $(".popover-content #password"), repassword = $(".popover-content #repassword"), email = $(".popover-content #email");
		console.log(account.val())
		if (account.val() == "" || !checkUserName(account.val())) {
			$(".popover-content #msg").text("账号格式不正确！");
			account.focus();
			return;
		}
		if (password.val() == "" || !verifyPassword(password.val())) {
			$(".popover-content #msg").text("密码格式不正确！");
			password.focus();
			return;
		}
		if (repassword.val() == "" || !verifyPassword(repassword.val())) {
			$(".popover-content #msg").text("确认密码格式不正确！");
			repassword.focus();
			return;
		}
		if (email.val() == "" || !checkEmail(email.val())) {
			$(".popover-content #msg").text("邮箱格式不正确！");
			email.focus();
			return;
		}
		$(".popover-content #msg").text("");
		$.ajax({
			url : "${ctx}/oc/jt-user/signup",
			type : "POST",
			data : {
				"account" : account.val(),
				"password" : password.val(),
				"repassword" : repassword.val(),
				"email" : email.val()
			},
			success : function(data) {
				if (data.errors != undefined) {
					var error = data.errors;
					$(".popover-content #msg").html(
							error[0].field + ":" + error[0].message);
					return;
				} else {
					if (data.code) {
						layer.msg(data.msg, {
							icon : 1
						});
					} else {
						$(".popover-content #msg").html(data.msg);
					}
				}
			}
		})
	}
	

	function login(){
		var login_uname = $(".popover-content #lg_uname").val();
		var login_pwd = $(".popover-content #lg_pwd").val();
		if(login_uname == ""){
			$(".popover-content #lg_uname").focus();
			$(".popover-content #msg").text("账号不能为空！");
			return;
		}
		if(login_pwd == ""){
			$(".popover-content #lg_pwd").focus();
			$(".popover-content #msg").text("密码不能为空！");
			return;
		}
		
		$.ajax({
			url:"${ctx}/oc/jt-user/signin",
			data:{"username":login_uname,"password":login_pwd},
			type : "POST",
			success:function(data){
				if(data == true){
					//layer.msg("登陆成功!");
					window.location.href= "${ctx}";
				}else{
					$(".popover-content #msg").text("登录失败！用户名或密码错误！");
				}
			}
		});
	}
	
	function logout() { //注销
		$.ajax({
			url : "${ctx}/oc/jt-user/logout",
			type : "post",
			success : function(res) {
				if (res == true) {
					window.location.href = "${ctx}";
				} else {
					alert("您未登录！");
				}
			}
		});
	}
</script>



<nav id="myScrollspy" class="navbar navbar-default navbar-static"
	role="navigation">
	<div class="container-fluid">
		<div class="navbar-header">
			<button class="navbar-toggle" type="button" data-toggle="collapse"
				data-target=".bs-js-navbar-scrollspy">
				<span class="sr-only">切换导航</span> <span class="icon-bar"></span> <span
					class="icon-bar"></span> <span class="icon-bar"></span>
			</button>
			<span class="glyphicon glyphicon-tower"></span> <a
				class="navbar-brand" href="${ctx}/"><img
				src="${ctx}/resources/hero/img/logo.png" /></a>
		</div>
		<div class="collapse navbar-collapse bs-js-navbar-scrollspy actions">
			<ul class="nav navbar-nav navbar-right popover-options">
				<li>
					<@shiro.guest>
					<a class="popover-destroy" id="sings" title="欢迎您!" data-container="body" data-toggle="popover" data-placement="bottom" data-content="<h4>登录</h4>" href="#">注册/登录 </a>
					</@shiro.guest>
					
					<@shiro.user>
						<a href="#" id="navbarDrop1" class="dropdown-toggle" data-toggle="dropdown">
						<span class="success">欢迎您&nbsp; <b id="nickName"></b></span><b class="caret"></b></a>
						<input type="hidden" id="curAcc" name="curAcc" value="<@shiro.principal property='account' />"/>
						<input type="hidden" id="curId" name="curAcc" value="<@shiro.principal property='id' />"/>
						<ul class="dropdown-menu" role="menu" aria-labelledby="navbarDrop1">							
							<li><a href="${ctx}/oc/setting/index" tabindex="-1">个人设置</a></li>
							<li><a href="${ctx}/oc/personal/index" tabindex="-1">个人中心</a></li>
							<!-- <li><a href="${ctx}/oc/serv" tabindex="-1">我的工作</a></li> -->
							<@shiro.hasRole name="administrator">
							<li><a href="${ctx}/back/config/" tabindex="-1">系统配置</a></li>
							</@shiro.hasRole>
							<li><a href="javascript:void(0);" onclick="logout();" tabindex="-1">退出</a></li>
						</ul>
					</@shiro.user> 
 				</li>

				<li class="dropdown"><a href="#" id="navbarDrop1"
					class="dropdown-toggle" data-toggle="dropdown">游戏<b
						class="caret"></b></a>
					<ul class="dropdown-menu" role="menu" aria-labelledby="navbarDrop1">						
						<li><a href="${ctx}/gm/home">进入游戏</a></li>
					</ul></li>


				<li class="dropdown"><a href="#" id="navbarDrop1"
					class="dropdown-toggle" data-toggle="dropdown">在线帮助<b
						class="caret"></b></a>
					<ul class="dropdown-menu" role="menu" aria-labelledby="navbarDrop1">						
						<li><a href="${ctx}/work/chat">客服中心</a></li>
						<li><a href="#helper">问题中心</a></li>
						<li><a href="${ctx}/login" data-toggle="modal"
							data-target="#ajax-modal">关于</a></li>
					</ul></li>


			</ul>
		</div>
	</div>
</nav>

<div id="ajax-modal" class="modal bs-modal bs-modal-middle" tabindex="-1" data-keyboard="false" data-backdrop="static"></div>

<div id="signin" class="sigin_on" title="登录" style="display: none;">
	<p class="login_til"><sapn>登录</span> <!-- <span class="pull-right"> 没有账号? <a onclick="to_singup();" class="text-danger">注册</a></span> --></p>
	<div class="col-xs-16">
		<div class="input-group">
			<span class="input-group-btn"><label class="btn btn-default" style="width:60px;" for="lg_uname">账 号</label></span>
			<input id="lg_uname" type="text" tabindex="1" class="form-control" name="username" placeholder="请输入您的账号">
		</div>
	</div>
	<div class="col-xs-16">
		<div class="input-group">
			<span class="input-group-btn"> <label class="btn btn-default" for="lg_pwd" style="width: 60px;">密 码</label></span>
			<input id="lg_pwd" type="password" tabindex="2" class="form-control" name="password" placeholder="请输入您的密码">
		</div>
	</div>
	<div id="msg" class="login_msg"></div>
	<div class="col-xs-16">
		<!-- <a href="#">找回密码</a> &nbsp;</span> 下次自动 <input type="checkbox" name="isAuto" /> -->
		<input class="pull-right btn btn-danger btn-xs"  tabindex="3" style="width: 65px" onclick="login();" value="登录" />
	</div>
	<br/>	
</div>

<div id="signup" class="sigin_on" title="注册" style="display: none;">
	<form class="bs-example bs-example-form" role="form">
		<p>
			<sapn>注册</span> <span class="pull-right"> <a href="#" class="text-danger" onclick="to_singin();">返回登录</a>
		</p>
		<div class="col-xs-16">
			<div class="input-group">
				<span class="input-group-btn"> <label class="btn btn-default" style="width: 80px;">账&nbsp;&nbsp;&nbsp;&nbsp;号</label></span>
				<input type="text" class="form-control" id="account" name="account" placeholder="账号格式：字母、数字、下划线组成，长度6-16位！" />
			</div>
		</div>
		<div class="col-xs-16">
			<div class="input-group">
				<span class="input-group-btn"> <label class="btn btn-default" style="width: 80px;">密&nbsp;&nbsp;&nbsp;&nbsp;码</label></span>
				<input type="password" class="form-control" id="password" name="password" placeholder="密码格式：长度6-16位！" />
			</div>
			<!-- /input-group -->
		</div>
		<div class="col-xs-16">
			<div class="input-group">
				<span class="input-group-btn"> <label class="btn btn-default"
					style="width: 80px;">确认密码</label>
				</span> <input type="password" class="form-control" id="repassword" name="repassword" placeholder="密码格式：长度6-16位！" />
			</div>
			<!-- /input-group -->
		</div>
		<div class="col-xs-16">
			<div class="input-group">
				<span class="input-group-btn"> <label class="btn btn-default"
					style="width: 80px;">邮&nbsp;&nbsp;&nbsp;&nbsp;箱</label>
				</span> <input type="text" class="form-control" id="email" name="email"
					placeholder="请输入正确的邮箱格式！" />
			</div>
			<!-- /input-group -->
		</div>
		<div id="msg"></div> 	
		<div class="col-xs-18">
			<input class="pull-right btn btn-danger btn-xs" type="button" onclick="regist()" value="注册" />
		</div>
	</form>
</div>

