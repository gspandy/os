<!DOCTYPE html>
<html lang="en">
<head>
<link type="text/css" rel="stylesheet" href="${ctx}/resources/hero/css/chat-console.css">
</head>
[#include "/core/head.html"/] [@head title="home.page.title"/]
<script type="text/javascript" src="${ctx}/resources/global/js/ajaxfileupload.js"></script>
<script type="text/javascript">
$(function (){
    $("[data-toggle='popover']").popover();
    [@shiro.user]
		var loginTime = '[@shiro.principal property="loginTime" /]';
		var lastLoginTime = '[@shiro.principal property="lastLoginTime" /]';
		$("#loginTime").text(new Date(loginTime).format("yyyy-MM-dd hh:mm:ss"));
		$("#lastLoginTime").text(new Date(lastLoginTime).format("yyyy-MM-dd hh:mm:ss"));
		if('[@shiro.principal property="accountType" /]' == 'administrator'){
			$("#accountType").text("超级管理员");
		}
		if('[@shiro.principal property="accountType" /]' == 'companyAdmin'){
			$("#accountType").text("客服管理员");
		}
		if('[@shiro.principal property="accountType" /]' == 'services'){
			$("#accountType").text("客服");
		}
		if('[@shiro.principal property="accountType" /]' == 'normal'){
			$("#accountType").text("普通用户");
		}
		if('[@shiro.principal property="accountState" /]' == 'normal'){
			$("#accountState").text("正常");
		}
		if('[@shiro.principal property="accountState" /]' == 'lock'){
			$("#accountState").text("锁定");
		}
		if('[@shiro.principal property="accountState" /]' == 'del'){
			$("#accountState").text("删除");
		}
	[/@shiro.user]
	
	//点击空白，隐藏上传头像弹出层
	$("#userIconEdit").on("click",function(){
		if(!$(this).attr('data-show')){
			$(this).attr('data-show','on');
			setTimeout(function(){
				$(document).on('click',showIcon);
			},100);
		}else{
			$(this).removeAttr('data-show');
			$(document).off('click',showIcon);
		}
	});
	$('body').on('click','.popover',function(ev){
		ev.stopPropagation();
	});
	var editObj = $("#userIconEdit");
	function showIcon(){
		editObj.click();
	}
	
});


//头像
function ajaxFileUploads() {
	var file_value = $("#file").val();
	var id = "file";
	if (file_value == '' || file_value == null || file_value == undefined) {
		layer.alert("请先选择图片!");
		return;
	}
	var houzui = file_value.substring(file_value.lastIndexOf(".") + 1,
			file_value.length);
	if (houzui == '' || houzui == null || houzui == undefined) {
		layer.alert("请选择正确图片格式!");
	}
	houzui = houzui.toLowerCase()
	if (houzui == 'jpg' || houzui == 'gif' || houzui == 'png'
			|| houzui == 'bmp' || houzui == 'swf') {
		//图片等待处理
		//上传图片
		$.ajaxFileUpload({
			url : '${ctx}/upload/img',
			secureuri : false,
			fileElementId : id,
			dataType : 'json',
			success : function(data, status) {
				if (data.result == "0") {
					var url = data.remoteurl;
					uploadIcon(url);
					$("#previewImg").attr("src",url);
				} else if (data.result == "1") {
					layer.alert("请先选择图片！");
				} else {
					layer.alert("上传出现异常！");
				}
			},
			error : function(data, status, e) { //相当于java中catch语句块的用法
				layer.alert("发生异常,上传失败!");
			}
		});
	} else {
		layer.alert("图片格式不正确!当前只支持jpg/gif/png/bmp/swf格式.");
	}
}
function uploadIcon(url){
	if(url == undefined || url == "")return;
	$.ajax({
		url:"${ctx}/oc/jt-user/update/icon",
		type:"POST",
		data:{"icon":url},
		success:function(data){
			if (data.errors != undefined) {
				var error = data.errors;
				layer.alert(error[0].field + ":" + error[0].message);
				return;
			} else if(data.code != undefined){
				layer.msg(data.msg, {icon: data.code? 1 : 2});
				if(data.code){
					layer.confirm(data.msg+"您需要重新登录后正常显示。", {
						  btn: ['去登录','稍候登录'] //按钮
						}, function(){
						  logout();
						});
				}
			} else {
				layer.alert("登录已超时！");
				window.location.href = "${ctx}";
			}
		}
	});
	
}
</script>
<body>
	[#include "/core/top.html"/]	
	<div class="container">
		<div class="row">
			<div class="col-sm-12 set_menu">
				[#include "/center/my_menu.html"/]				
			</div>
			<div class="col-sm-12 tab-content text-left">
				<div class="tab-pane fade in active" id="base">
					<h4 class="menu_til"><a href="${ctx}/oc/setting/info" data-toggle="modal" data-target="#ajax-modal" class="strong">修改资料</a></h4>					
					<div id="login_mail" class="login_m">
						<span class="text-muted">登录账号：</span> <span class="strong name-login">[@shiro.principal property="account" /]</span>
					</div>
					<div id="nick_name" class="col-sm-12 nicks clearfix">
						<div  class="col-xs-6 l40">
							<div id="icon" ><span class="text-muted">头像：</span>
								[#if curIcon??]<img alt="" class="img-circle" src="${curIcon}" />[#else]<img class="img-circle" alt="" src="${ctx}/resources/hero/img/user.jpg"/>[/#if]  
								<a class="popover-hide" id="userIconEdit" title="修改头像" data-container="body" data-toggle="popover" data-html="true" data-placement="bottom" data-content='<span>
								[#if curIcon??]<img alt="" id="previewImg" class="img-circle" src="${curIcon}">
									[#else]<img id="previewImg" class="img-circle" alt="" src="${ctx}/resources/hero/img/user.jpg">
								[/#if]
								</span>
								<input type="file" name="file" id="file" onchange="ajaxFileUploads()" style="display:none"/>
								<input type="button" class="pull-right btn new_poto" onclick=$("#file").click(); value="上传新头像"/>' href="javascript:void(0)">更改</a>
							</div> 
						</div>
						<div class="col-xs-6 l40">
							[#if curNickName?? ]<span class="text-muted">昵称：</span>${curNickName}[#else]<span class="text-muted">昵称：</span>(您未设置昵称)[/#if] 
							<!-- <a class="popover-hide" id="nickNameEdit" title="修改昵称" data-container="body" data-toggle="popover" data-html="true" data-placement="bottom" 
							data-content='<input type="text" name="nickName" id="newNickName" placeholder="请输入新的昵称"/>
							<input class="pull-right btn" type="button" onclick="updateData(1)" value="保存" />'
							href="#">更改</a> -->
						</div>					
					</div>
					<div id="data" class="col-sm-12 acc_data">
						<h3 id="data_title">资料</h3>
						<ul>
							<li><span>邮箱：</span><span>[#if email?? ]${email}[#else](您未设置邮箱)[/#if]</span></li>
							<li><span>联系方式：</span><span>[#if mobile?? ]${mobile}[#else](您未设置联系方式)[/#if]</span></li>
							<li><span>所属公司：</span><span>[#if companyName?? ]${companyName}[#else](暂无)[/#if]</span></li>
							<li><span>本次登录ip：</span><span>[@shiro.principal property="loginIp"/]</span></li>
							<li><span>本次登录时间：</span><span><d id="loginTime"></d></span></li>
							<li><span>最后一次登录ip：</span><span>[@shiro.principal property="lastLoginIp"/]</span></li>
							<li><span>最后一次登录时间：</span><span><d id="lastLoginTime"></d></span></li>
							<li><span>账号类型：</span><span><d id="accountType"></d></span></li>
							<li><span>账号状态：</span><span><d id="accountState"></d></span></li>
						</ul>						
					</div>					
				</div>
			</div>
		</div>
	</div>
	[#include "/core/foot.html"/]
</body>
</html>