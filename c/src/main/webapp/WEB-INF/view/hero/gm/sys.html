<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link type="text/css" rel="stylesheet"
	href="${ctx}/resources/global/js/countdown/jquery.classycountdown.min.css" />
<link type="text/css" rel="stylesheet" href="${ctx}/resources/hero/css/pcoo.css"  />
</head>

<body>
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal"
			aria-hidden="true">X</button>
		<h4 class="modal-title">
			<span id="gm_name" class="username-msg">${game.name}</span> / <span>距离
				<span class="username-msg">${cln.issue}</span> 截止
			</span>
		</h4>

		<div class="clearfix">
			<div id="countdown" class="countdown"></div>
			<div class="history-1">
				第<span>${lastLN.issue}</span>期<span>${lastLN.lotteryNumber}</span> <a
					href="#" id="history-1"  data-trigger="focus" data-placement="bottom" ><small
					class="glyphicon glyphicon-chevron-down"></small></a>
			</div>
			<div id="history-1-con" style="display: none;">
				<ul id="history-list" class="history-list">
					<li><span>3232</span></li>
					 
				</ul>
			</div>
		</div>
	</div>
	<div id="gmConsole" class="modal bs-modal bs-modal-middle" tabindex="-1"></div>

	<div class="modal-control">
		<input type="hidden" name="format" value="json">
		<div class="modal-body">
			<div class="form-body">
				<div id="console" class="blue"></div>
				<form class="well form-inline" onsubmit="return false;">
					<!-- <input id="mbody" class="input-xlarge" type="text"
						placeholder="Type something..." />
					<button type="button" onClick="sendMessage()" class="btn" id="send">Send</button> -->
					<!-- <button type="button" class="btn dropdown-toggle" id="navbarDrop1"
						data-toggle="dropdown">预约</button> -->
					<!-- <div class="dropdown-menu" role="menu" aria-labelledby="navbarDrop1">
						<div class="view">
							<h4 class="text-center">大小单双</h4>
							<h6 class="text-center">中奖和值:[14,15,16,17,18,19,20,21,22,23,24,25,26,27]</h6>
							<div class="container">
								<a href="#" class="col-1"><h4>大</h4>
									<h3>1:2.0</h3></a> <a href="#" class="col-1"><h4>小</h4>
									<h3>1:2.0</h3></a> <a href="#" class="col-1"><h4>单</h4>
									<h3>1:2.0</h3></a> <a href="#" class="col-1"><h4>双</h4>
									<h3>1:2.0</h3></a> <a href="#" class="col-1"><h4>极大</h4>
									<h3>1:15.0</h3></a> <a href="#" class="col-1"><h4>大单</h4>
									<h3>1:4.2</h3></a> <a href="#" class="col-1"><h4>小单</h4>
									<h3>1:4.6</h3></a> <a href="#" class="col-1"><h4>大双</h4>
									<h3>1:4.6</h3></a> <a href="#" class="col-1"><h4>小双</h4>
									<h3>1:4.2</h3></a> <a href="#" class="col-1"><h4>极小</h4>
									<h3>1:15.0</h3></a>
							</div>
							<div class="mboth">
								<button type="button" class="btn btn-default pull-left">赔率说明</button>
								<button type="button" class="btn btn-primary pull-right"
									style="margin-left: 5px;">双倍投注</button>
								<button type="button" class="btn btn-primary pull-right">最小投注</button>
							</div>
							<div class="mboth">
								投注金额： <input type="text" class="form-control" id="name"
									placeholder="">
								<button type="button" class="btn btn-warning">投注</button>
							</div>
						</div>
					</div> -->
					<button type="button" id="pBetBtn">预约</button>


					<select id="pt_group" onchange="changePT()">
						<#list ptGroup as pt>
						<option value="${pt.id}">${pt.groupName}</option>
						</#list>
					</select> <span id="pt_type"></span>

					<!-- <button type="button" onClick="sendDisconnect()" class="btn">Disconnect</button> -->
				</form>
			</div>
		</div>

		<div class="modal-footer">
			<button type="button" class="btn default" data-dismiss="modal">关闭</button>
			<!-- <button type="submit" class="btn blue">1212121</button> -->
		</div>
	</div>
	<!-- 模态框（Modal） -->
<div class="modal fade" id="betModal" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
      <div class="form-body">
      <form class="well form-inline" onsubmit="return false;">
         <div class="modal-header">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h4 class="modal-title" id="myModalLabel">
             	<!-- <h4 class="text-center">大小单双</h4> -->
             	<h4 class="text-center">
             	<select id="betPtGroup" onchange="changePtGroup()">
             		<#list ptGroup as pt>
						<option value="${pt.id}">${pt.groupName}</option>
					</#list>
             	</select>
             	</h4>
				<h6 class="text-center">中奖和值:[14,15,16,17,18,19,20,21,22,23,24,25,26,27]</h6>
            </h4>
         </div>
         <div class="modal-body">
				<div class="container" id="betContent">
					<a href="#" class="col-1"><h4>大</h4><h3>1:2.0</h3></a>
					<a href="#" class="col-1"><h4>小</h4><h3>1:2.0</h3></a> 
					<a href="#" class="col-1"><h4>单</h4><h3>1:2.0</h3></a> 
					<a href="#" class="col-1"><h4>双</h4><h3>1:2.0</h3></a> 
					<a href="#" class="col-1"><h4>极大</h4><h3>1:15.0</h3></a> 
					<a href="#" class="col-1"><h4>大单</h4><h3>1:4.2</h3></a> 
					<a href="#" class="col-1"><h4>小单</h4><h3>1:4.6</h3></a> 
					<a href="#" class="col-1"><h4>大双</h4><h3>1:4.6</h3></a> 
					<a href="#" class="col-1"><h4>小双</h4><h3>1:4.2</h3></a> 
					<a href="#" class="col-1"><h4>极小</h4><h3>1:15.0</h3></a>
				</div>
         </div>
         <div class="modal-footer">
         	<div class="mboth">
				<button type="button" class="btn btn-default pull-left">赔率说明</button>
				<button type="button" class="btn btn-primary pull-right"
					style="margin-left: 5px;">双倍投注</button>
				<button type="button" class="btn btn-primary pull-right">最小投注</button>
			</div>
			<div class="mboth">
				投注金额： <input type="text" class="form-control" id="name"
					placeholder="">
				<button type="button" class="btn btn-warning">投注</button>
			</div>
         </div>
         </form>
         </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
	<script type="text/javascript">
		//加载倒计时器
		$(document).ready(function() {
			var closeTime = '${cln.closeTime}';
			reClock(closeTime);
			$("#history-1").popover({
				trigger:'click',
				placement : 'bottom',
				html : true,
				content:loadHistory()
			});

			//loadHistory('${game.id}');
			//$("#history-1").attr("data-content", $("#history-1-con").html());
			
			$('#history-1').on('show.bs.popover', function () {
				//加载历史 
				$("#history-list").html("<li><span>heelo<span></li>");
				
			});
		});
		//预约
		$("#pBetBtn").on("click", function(){
			changePtGroup();
			$("#betModal").modal("show");
		})
		function changePtGroup(){
			var groupId = $("#betPtGroup").val();
			$.ajax({
				type : "GET",
				url : "${ctx}/play/gm/${game.id}",
				data : {
					pgid : groupId
				},
				beforeSend : loading,//执行ajax前执行loading函数.直到success 
				success : function(data){
					console.log(data)
					var html = "";
					if(data.length > 0){
						for(var i = 0 ; i < data.length; i ++ ){
							html += "<a href=\"javascript:void(0);\" class=\"col-1\"><h4>"+data[i].name+"</h4><h3>1:"+data[i].multiplyingPower+"</h3></a>";
						}
					}
					$("#betContent").html(html);
				}
			});
		}
		
		function reClock(closeTime){
			var tar_time = new Date(closeTime.replace(/-/g, "/")).getTime(); //兼容safari 时间处理方式
			var end_time = Math.floor((tar_time - ($.now())) / 1000);
			// alert(end_time);
			$('#countdown').empty();
			$('#countdown').ClassyCountdown({
				theme : "black-very-wide",
				labelsOptions : {
					lang : {
						days : 'D',
						hours : 'H',
						minutes : 'M',
						seconds : 'S'
					},
					style : 'font-size:14px; text-transform:uppercase;'
				},
				end : $.now() + end_time
			});
		}

		function loadHistory() {
			var str="<ul id=\"history-list\" class=\"history-list\">";
			var gmid = '${game.id}';
			$.ajax({
				type : "GET",
				url : "${ctx}/ln/history/" + gmid,
				beforeSend : loading,
				async:false,
				success : function(data) {
					for(var i = 0; i < data.length; i ++){
						str += "<li>第<span>"+data[i].issue+"</span>期<span>"+data[i].lotteryNumber+"</span></li>";
					}
				}
			});
			str += "</ul>";
			return str;
		}

		function showHis(data) {
			return '<div>soul</div>'
		}

		//加载类型
		function changePT() {
			var ptgid = $("#pt_group").val();
			$.ajax({
				type : "GET",
				url : "${ctx}/play/gm/${game.id}",
				data : {
					pgid : ptgid
				},
				beforeSend : loading,//执行ajax前执行loading函数.直到success 
				success : Response
			//成功时执行Response函数 
			});
		}

		function loading() {
			$('#loading_img').html('<img src="images/loading.gif"/>');
		}

		function Response(data) {
			console.log(data);
			var hml = '<select id="pt_group" onchange="changePT()">';
			data.forEach(function(value, index, array) {
				hml += '<option value="'+value.id+'">' + value.name
						+ '</option>';
			});
			hml += '</select>';
			$('#pt_type').html(hml);
		}
	</script>

	<script type="text/javascript">
		var socket;
		var host = window.location.host;
		if ('WebSocket' in window) {
			socket = new WebSocket("ws://" + host + "/jt-io/gm");
		} else if ('MozWebSocket' in window) {
			socket = new MozWebSocket("ws://" + host + "/jt-io/gm");
		} else {
			socket = new SockJS("http://" + host + "/jt-io/gm/js");
		}

		socket.onopen = function(evt) {
			openOnline();
		};

		function openOnline() {
			sendMessage();
			output('<span class="connect-msg">尊敬的用户,欢迎来到 ${game.name} 房间</span>');
		}

		function sendMessage() {
			var body = $('#mbody').val();
			$('#mbody').val('');

			var uid = -3;
			var proto = {
				uid : uid,
				body : body,
				type : 'join'
			};
			socket.send(JSON.stringify(proto));
		}

		socket.onmessage = function(evt) {
			var PRO_ = JSON.parse(evt.data);
			switch (PRO_.type) {
			case "bet":
				betMsg(PRO_);
				break;

			default:
				ltMsg(PRO_);
				break;
			}
		};

		function betMsg(PRO_) {
			output('<span class="connect-msg">' + PRO_.body +'</span>');
		}

		function ltMsg(PRO_) {
			var ln = JSON.parse(PRO_.body);
			console.log(ln);
			
			if(ln.status=='OPEN'){
				var c_time=ln.closeTime;
				reClock(getSmpFormatDateByLong(c_time));
			}
			
			if ("" == ln.lotteryNumber) {
				output('<span class="connect-msg">' + ln.issue + ' > 状态 :'
						+ ln.status + '</span>');
			} else {
				output('<span class="connect-msg">' + ln.issue + ' > 状态 :'
						+ ln.status + ' > NUM:' + ln.lotteryNumber + '</span>');
			}
		}

		socket.onclose = function(evt) {
			closeOffline(evt);
		};

		socket.onerror = function(evt) {
			alert("与服务器的连接出现了问题.");
		};

		function output(message) {
			var currentTime = "<span class='time'>"
					+ moment().format('HH:mm:ss') + "</span>";
			var element = $("<div>" + currentTime + " " + message + "</div>");
			$('#console').prepend(element);
		}

		$(document).keydown(function(e) {
			if (e.keyCode == 13) {
				$('#send').click();
			}
		});
	</script>
	<script src="${ctx}/resources/global/js/socket.io/moment.min.js"></script>
	<script src="${ctx}/resources/global/js/countdown/jquery.knob.js"></script>
	<script src="${ctx}/resources/global/js/countdown/jquery.throttle.js"></script>
	<script src="${ctx}/resources/global/js/countdown/jquery.classycountdown.min.js"></script>
	<script src="${ctx}/resources/hero/js/dateformat.js"></script>

</body>
</html>